<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üéß Streamline Player</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f4f4f4;
        margin: 0;
        color: #333;
      }

      .container {
        max-width: 480px;
        margin: auto;
        padding: 10px;
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      h2 {
        text-align: center;
        font-size: 20px;
        margin-bottom: 16px;
      }

      .book-buttons,
      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
        margin-bottom: 12px;
      }
      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
        margin-bottom: 12px;
      }

      button {
        padding: 8px;
        font-size: 13px;
        border: none;
        border-radius: 50%;
        background: #e0e0e0;
        cursor: pointer;
        transition: 0.2s ease-in-out;
      }

      button:hover {
        background: #d0d0d0;
      }

      button.active {
        background: #007aff;
        color: white;
        font-weight: bold;
      }

      .audio-row {
        display: flex;
        align-items: center;
        gap: 5px;
        justify-content: center;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      audio {
        flex-grow: 1;
      }

      .rewind-btn {
        background: #007aff;
        color: white;
        border-radius: 30px;

        font-size: 14px;
      }

      .speed-toggle {
        border-radius: 30px;
        background: #ffeaa7;
        color: #2d3436;
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
        font-weight: 600;
        padding: 6px 10px;
        border: none;
        cursor: pointer;
      }

      .speed-toggle .icon {
        font-size: 16px;
      }

      .speed-toggle .value {
        color: #555;
        font-size: 12px;
      }
      .custom-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 16px;
        justify-content: center;
      }
      #playBtn {
        background: #4cd964;
        color: white;
        font-size: 16px;
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
      }

      #progress {
        flex-grow: 1;
        height: 6px;
        border-radius: 5px;
        accent-color: #007aff;
        min-width: 100px;
      }
      .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>üéß Streamline Listening</h2>

      <div class="book-buttons">
        <button onclick="selectBook(1)">Book 1</button>
        <button onclick="selectBook(2)">Book 2</button>
        <button onclick="selectBook(3)">Book 3</button>
        <button onclick="selectBook(4)">Book 4</button>
      </div>

      <div id="fileButtons"></div>

      <div class="audio-row">
        <button class="rewind-btn" onclick="seekAudio(-5)">‚è™ 5s</button>

        <audio id="audio" preload="auto"></audio>

        <button id="playBtn">‚ñ∂Ô∏è</button>

        <input
          type="range"
          id="progress"
          value="0"
          min="0"
          max="100"
          step="0.1"
        />

        <button class="speed-toggle" onclick="toggleSpeed()" id="speedBtn">
          <span class="icon" id="speedIcon">üêá</span>
          <span id="speedValue" class="value">1x</span>
        </button>
      </div>
      <div id="leaderboard" class="daily-leaderboard"></div>
    </div>

    <script>
      const fileButtonsContainer = document.getElementById("fileButtons");
      const audio = document.getElementById("audio");
      const speedIcon = document.getElementById("speedIcon");
      const speedValue = document.getElementById("speedValue");

      let currentBook = 1;
      let currentIndex = 0;

      const audioFiles = {
        1: Array.from({ length: 80 }, (_, i) => i + 1)
          .filter((i) => ![3, 20, 40, 53, 60, 68, 70, 76, 78, 80].includes(i))
          .map((i) => `streamline1/${String(i).padStart(2, "0")}.mp3`),

        2: Array.from({ length: 80 }, (_, i) => i + 1)
          .filter((i) => ![8, 24, 45, 53, 59, 67, 72, 78, 80].includes(i))
          .map((i) => `streamline2/${String(i).padStart(2, "0")}.mp3`),

        3: Array.from({ length: 80 }, (_, i) => i + 1)
          .filter(
            (i) =>
              ![
                6, 8, 14, 26, 30, 33, 41, 48, 49, 50, 55, 58, 61, 64, 66, 68,
                69, 70, 73, 79,
              ].includes(i)
          )
          .map((i) => `streamline3/${String(i).padStart(2, "0")}.mp3`),

        4: Array.from({ length: 60 }, (_, i) => i + 1)
          .filter(
            (i) =>
              ![
                5, 8, 9, 12, 14, 18, 23, 27, 29, 30, 32, 35, 37, 38, 41, 43, 44,
                46, 48, 51, 53, 56, 60,
              ].includes(i)
          )
          .map((i) => `streamline4/${String(i).padStart(2, "0")}.mp3`),
      };

      function selectBook(bookNum) {
        currentBook = bookNum;
        localStorage.setItem("lastBook", bookNum);
        renderBookButtons(bookNum);
        renderFileButtons(bookNum);
        loadLastAudio();
      }

      function renderBookButtons(activeBook) {
        document
          .querySelectorAll(".book-buttons button")
          .forEach((btn, idx) => {
            btn.classList.toggle("active", idx + 1 === activeBook);
          });
      }

      function renderFileButtons(bookNumber) {
        fileButtonsContainer.innerHTML = "";
        const files = audioFiles[bookNumber];

        const row = document.createElement("div");
        row.className = "button-row";

        files.forEach((file, i) => {
          const btn = document.createElement("button");

          const labelMatch = file.match(/(\d{2})\.mp3$/);
          const label = labelMatch ? String(Number(labelMatch[1])) : i + 1;

          btn.textContent = label;
          btn.onclick = () => playAudio(i);
          row.appendChild(btn);
        });

        fileButtonsContainer.appendChild(row);
      }

      function updateActiveButton(index) {
        document.querySelectorAll(".button-row button").forEach((btn, idx) => {
          btn.classList.toggle("active", idx === index);
        });
      }

      function playAudio(index) {
        currentIndex = index;
        const file = audioFiles[currentBook][index];
        audio.src = file;
        audio.play();
        updateActiveButton(index);
        saveLastAudio();
      }

      function seekAudio(seconds) {
        audio.currentTime += seconds;
      }

      function toggleSpeed() {
        if (audio.playbackRate === 1) {
          audio.playbackRate = 0.75;
          speedIcon.textContent = "üê¢";
          speedValue.textContent = "0.75x";
        } else {
          audio.playbackRate = 1;
          speedIcon.textContent = "üêá";
          speedValue.textContent = "1x";
        }
      }

      function saveLastAudio() {
        localStorage.setItem(
          "lastAudio",
          JSON.stringify({ book: currentBook, index: currentIndex })
        );
      }

      function loadLastAudio() {
        const saved = localStorage.getItem("lastAudio");
        if (saved) {
          const { book, index } = JSON.parse(saved);
          if (book === currentBook) playAudio(index);
        } else {
          playAudio(0);
        }
      }

      selectBook(Number(localStorage.getItem("lastBook") || 1));

      const playBtn = document.getElementById("playBtn");
      const progress = document.getElementById("progress");

      const sheetId = "1Co3Z7cUfXhgWcmPcQYvzAfYPn8W9n5cOGIWFkRsZoK4";
      const sheetName = "Sheet1";
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${sheetName}`;

      // X√≥a d·∫•u ti·∫øng Vi·ªát, vi·∫øt th∆∞·ªùng, kh√¥ng kho·∫£ng tr·∫Øng
      function toSlug(str) {
        return str
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/ƒë/g, "d")
          .replace(/ƒê/g, "D")
          .toLowerCase()
          .replace(/\s+/g, "");
      }

      async function fetchSheetData() {
        const response = await fetch(url);
        const text = await response.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));

        const rows = json.table.rows.map((row) => ({
          name: row.c[1]?.v || "",
          streak: row.c[2]?.v || 0,
          coins: row.c[3]?.v || 0,
        }));

        return rows;
      }

      async function renderLeaderboardFromSheet() {
        const lb = document.getElementById("leaderboard");
        lb.innerHTML = "";

        const users = await fetchSheetData();

        users.forEach((user) => {
          const slugName = toSlug(user.name);
          const avatarSrc = `img-user/${slugName}.jpg`;

          const rankDiv = document.createElement("div");
          rankDiv.className = "rank";
          rankDiv.style.display = "flex";
          rankDiv.style.alignItems = "center";
          rankDiv.style.border = "1px solid #eee";
          rankDiv.style.borderRadius = "8px";
          rankDiv.style.padding = "8px 12px";
          rankDiv.style.marginBottom = "8px";
          rankDiv.style.background = "#fafafa";

          const avatar = document.createElement("img");
          avatar.src = avatarSrc;
          avatar.alt = user.name;
          avatar.style.width = "40px";
          avatar.style.height = "40px";
          avatar.style.borderRadius = "50%";
          avatar.style.marginRight = "12px";
          avatar.style.objectFit = "cover";

          const infoDiv = document.createElement("div");
          infoDiv.innerHTML = `
      <div><strong>${user.name}</strong></div>
      <div style="font-size: 0.9em; color: #666;">üî• ${user.streak} ng√†y ‚Ä¢ üí∞ ${user.coins}</div>
    `;

          rankDiv.appendChild(avatar);
          rankDiv.appendChild(infoDiv);
          lb.appendChild(rankDiv);
        });
      }

      renderLeaderboardFromSheet();

      playBtn.onclick = () => {
        if (audio.paused) {
          audio.play();
          playBtn.textContent = "‚è∏Ô∏è";
        } else {
          audio.pause();
          playBtn.textContent = "‚ñ∂Ô∏è";
        }
      };

      audio.addEventListener("timeupdate", () => {
        const percent = (audio.currentTime / audio.duration) * 100;
        progress.value = percent || 0;
      });

      progress.addEventListener("input", () => {
        const percent = progress.value;
        audio.currentTime = (percent / 100) * audio.duration;
      });

      audio.addEventListener("ended", () => {
        playBtn.textContent = "‚ñ∂Ô∏è";
      });
    </script>
  </body>
</html>

<!-- quyen 1 co 80 bai nhung thieu: 3,20, 40, 53,60,68 70 76 78 80 -->
<!-- quyen 2 co 80 bai nhung thieu: 8,24 45 53 59 67 72 78 80 -->
<!-- quyen 3 co 80 bai nhung thieu: 6 8 14 26 30 33 41 48 49 50 55 58 61 64 66 68 69 70 73 79  -->
<!-- quyen 4 chi co 60 bai thoi ma bi thieu mat cac bai sau: 5 8 9 12 14 18 23 27 29 30 32 35 37 38 41 43 44 46 48 51 53 56 60 -->
